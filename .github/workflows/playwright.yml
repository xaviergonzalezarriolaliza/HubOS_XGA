name: Playwright Tests

on:
  push:
    branches: ['**']

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Write .env
        run: |
          cat > .env <<'EOF'
CORRECT_LOGIN="Dafoe"
CORRECT_LOGIN2="Will"
CORRECT_LOGIN3="Daf"
CORRECT_LOGIN4="Willem Dafoe"
INCORRECT_LOGIN="Follet Verd"
INCORRECT_LOGIN2="Green Dwarf"
ROOM="0440"
ROOM2="440"
WRONG_ROOM="00440"
WRONG_ROOM2="9999"
DEMOHUB="Hotel Demo Hub"
BASE_URL="https://dev.hub-buildings.com/guest/index/login/eyJpZF9idWlsZGluZyI6IjgiLCJndWVzdF9uYW1lIjoiIiwiZ3Vlc3Rfcm9vbSI6IiIsImlkX2xhbmciOiIxIiwibGFuZ3VhZ2UiOiJFUyIsImdpdF9oZWFkZXJfaW1hZ2UiOiJodHRwczovL2Rldi5odWItYnVpbGRpbmdzLmNvbS9maWxlcy9ocHMvYnVpbGRpbmc4L2ltYWdlcy84XzIwMjIxMjAxMTAxMTAzXzYzODg3ZGI3ZWIwODMuanBlZyJ9"
PARTIAL_LOGIN="Daf"
PARTIAL_LOGIN2="Wil"
PARTIAL_LOGIN3="Par3"
EOF

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'

      - name: Install & run tests
        run: |
          npm ci
          npx playwright install --with-deps
          npx playwright test --reporter=list,html --workers=2

      - name: Zip report and guard by size
        if: always()
        run: |
          rm -f report.zip || true
          if [ -d playwright-report ]; then
            zip -r report.zip playwright-report || true
            SIZE_KB=$(du -k report.zip | cut -f1)
            echo "REPORT_SIZE_KB=$SIZE_KB" >> $GITHUB_ENV
            if [ "$SIZE_KB" -gt 51200 ]; then
              echo "SKIP_ARTIFACTS=true" >> $GITHUB_ENV
              echo "Report too large ($SIZE_KB KB), skipping upload"
            fi
          fi

      - name: Upload Playwright report (zip)
        if: ${{ env.SKIP_ARTIFACTS != 'true' }}
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: report.zip
          if-no-files-found: warn

      - name: Upload Playwright test-results
        uses: actions/upload-artifact@v4
        with:
          name: playwright-test-results
          path: test-results
          if-no-files-found: warn
name: Playwright Tests

on:
  push:
    branches: ['**']

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Write .env
        run: |
          cat > .env <<'EOF'
CORRECT_LOGIN="Dafoe"
CORRECT_LOGIN2="Will"
CORRECT_LOGIN3="Daf"
CORRECT_LOGIN4="Willem Dafoe"
INCORRECT_LOGIN="Follet Verd"
INCORRECT_LOGIN2="Green Dwarf"
ROOM="0440"
ROOM2="440"
WRONG_ROOM="00440"
WRONG_ROOM2="9999"
DEMOHUB="Hotel Demo Hub"
BASE_URL="https://dev.hub-buildings.com/guest/index/login/eyJpZF9idWlsZGluZyI6IjgiLCJndWVzdF9uYW1lIjoiIiwiZ3Vlc3Rfcm9vbSI6IiIsImlkX2xhbmciOiIxIiwibGFuZ3VhZ2UiOiJFUyIsImdpdF9oZWFkZXJfaW1hZ2UiOiJodHRwczovL2Rldi5odWItYnVpbGRpbmdzLmNvbS9maWxlcy9ocHMvYnVpbGRpbmc4L2ltYWdlcy84XzIwMjIxMjAxMTAxMTAzXzYzODg3ZGI3ZWIwODMuanBlZyJ9"
PARTIAL_LOGIN="Daf"
PARTIAL_LOGIN2="Wil"
PARTIAL_LOGIN3="Par3"
EOF

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'

      - name: Install & run tests
        run: |
          npm ci
          npx playwright install --with-deps
          npx playwright test --reporter=list,html --workers=2

      - name: Zip report and guard by size
        if: always()
        run: |
          rm -f report.zip || true
          if [ -d playwright-report ]; then
            zip -r report.zip playwright-report || true
            SIZE_KB=$(du -k report.zip | cut -f1)
            echo "REPORT_SIZE_KB=$SIZE_KB" >> $GITHUB_ENV
            if [ "$SIZE_KB" -gt 51200 ]; then
              echo "SKIP_ARTIFACTS=true" >> $GITHUB_ENV
              echo "Report too large ($SIZE_KB KB), skipping upload"
            fi
          fi

      - name: Upload Playwright report (zip)
        if: ${{ env.SKIP_ARTIFACTS != 'true' }}
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: report.zip
          if-no-files-found: warn

      - name: Upload Playwright test-results
        uses: actions/upload-artifact@v4
        with:
          name: playwright-test-results
          path: test-results
          if-no-files-found: warn
name: Playwright Tests

on:
  push:
    branches:
      - '**'

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4


      - name: Set up environment variables for Playwright
        run: |
          echo 'CORRECT_LOGIN="Dafoe"' >> .env
          echo 'CORRECT_LOGIN2="Will"' >> .env
          echo 'CORRECT_LOGIN3="Daf"' >> .env
          echo 'CORRECT_LOGIN4="Willem Dafoe"' >> .env
          echo 'INCORRECT_LOGIN="Follet Verd"' >> .env
          echo 'INCORRECT_LOGIN2="Green Dwarf"' >> .env
          echo 'ROOM="0440"' >> .env
          echo 'ROOM2="440"' >> .env
          echo 'WRONG_ROOM="00440"' >> .env
          echo 'WRONG_ROOM2="9999"' >> .env
          echo 'DEMOHUB="Hotel Demo Hub"' >> .env
          echo 'BASE_URL="https://dev.hub-buildings.com/guest/index/login/eyJpZF9idWlsZGluZyI6IjgiLCJndWVzdF9uYW1lIjoiIiwiZ3Vlc3Rfcm9vbSI6IiIsImlkX2xhbmciOiIxIiwibGFuZ3VhZ2UiOiJFUyIsImdpdF9oZWFkZXJfaW1hZ2UiOiJodHRwczovL2Rldi5odWItYnVpbGRpbmdzLmNvbS9maWxlcy9ocHMvYnVpbGRpbmc4L2ltYWdlcy84XzIwMjIxMjAxMTAxMTAzXzYzODg3ZGI3ZWIwODMuanBlZyJ9"' >> .env
          echo 'PARTIAL_LOGIN="Daf"' >> .env
          echo 'PARTIAL_LOGIN2="Wil"' >> .env
          echo 'PARTIAL_LOGIN3="Par3"' >> .env

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright Browsers
        run: npx playwright install --with-deps

      - name: Run Playwright tests
        run: npx playwright test --reporter=list,html --workers=2

      - name: Show Playwright report files
        if: always()
        run: |
          echo "Report folder listing:"
          ls -la playwright-report || true
          echo "Report files (up to depth 3):"
          find playwright-report -maxdepth 3 -type f -print || true

      - name: Zip Playwright report
        if: always()
        run: |
          rm -f report.zip
          if [ -d playwright-report ]; then
            zip -r report.zip playwright-report || true
            SIZE_KB=$(du -k report.zip | cut -f1)
            echo "REPORT_SIZE_KB=$SIZE_KB" >> $GITHUB_ENV
            echo "REPORT_ZIP=report.zip" >> $GITHUB_ENV
            echo "Report zipped: report.zip (${SIZE_KB} KB)"
          else
            echo "No playwright-report folder to zip"
          fi

      - name: Check report size
        if: always()
        run: |
          THRESHOLD_KB=51200
          echo "Threshold KB: $THRESHOLD_KB"
          if [ "${REPORT_SIZE_KB:-0}" -gt "$THRESHOLD_KB" ]; then
            echo "SKIP_ARTIFACTS=true" >> $GITHUB_ENV
            echo "Report too large (${REPORT_SIZE_KB} KB), skipping artifact upload."
          else
            echo "Report size OK: ${REPORT_SIZE_KB:-0} KB"
          fi

      - name: Check GitHub artifact storage usage
        if: always()
        env:
          GITHUB_API_URL: https://api.github.com
        run: |
          # ARTIFACT_STORAGE_QUOTA_MB can be configured as a repo secret or left as default
          STORAGE_QUOTA_MB=${ARTIFACT_STORAGE_QUOTA_MB:-50000}
          echo "Using storage quota (MB): $STORAGE_QUOTA_MB"
          curl -s -H "Authorization: token $GITHUB_TOKEN" "$GITHUB_API_URL/repos/$GITHUB_REPOSITORY/actions/artifacts?per_page=100" > artifacts.json || true
          REPO_ARTIFACTS_KB=$(python - <<'PY'
import json,sys
try:
    j=json.load(open('artifacts.json'))
except Exception:
    print(0)
    sys.exit(0)
items=j.get('artifacts',[])
print(sum(a.get('size_in_bytes',0) for a in items)//1024)
PY
)
          echo "REPO_ARTIFACTS_KB=$REPO_ARTIFACTS_KB" >> $GITHUB_ENV
          REPORT_SIZE_KB=${REPORT_SIZE_KB:-0}
          AVAILABLE_KB=$((STORAGE_QUOTA_MB*1024 - REPO_ARTIFACTS_KB))
          echo "Available artifact storage (KB): $AVAILABLE_KB"
          if [ "$AVAILABLE_KB" -le 0 ] || [ "$AVAILABLE_KB" -lt "$REPORT_SIZE_KB" ]; then
            echo "SKIP_ARTIFACTS=true" >> $GITHUB_ENV
            echo "Not enough artifact storage: available ${AVAILABLE_KB} KB, report ${REPORT_SIZE_KB} KB"
          else
            echo "Sufficient storage for upload: available ${AVAILABLE_KB} KB"
          fi

      - name: Upload Playwright report artifact (zip)
        if: ${{ env.SKIP_ARTIFACTS != 'true' }}
        continue-on-error: true
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: report.zip
          if-no-files-found: warn

      - name: Upload Playwright test-results artifact
        if: always()
        continue-on-error: true
        uses: actions/upload-artifact@v4
        with:
          name: playwright-test-results
          path: test-results
          if-no-files-found: warn
          
